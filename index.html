<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Briefings - Tabela/Cards</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    .form-switch .form-check-input {
      width: 3em; 
      margin-left: -2.5em;
    }
    .btn-check + .btn {
      position: relative; 
      min-width: 2.5rem;
    }
    .btn-check:checked + .btn {
      background-color: #f8f9fa !important;
      border-color: #f8f9fa !important; 
      color: #212529 !important; 
    }
    .btn-check:checked + .btn::before {
      content: "✔";
      color: #000; 
      position: absolute; 
      left: 0.5rem; 
      top: 0.3rem;
    }
    .table-step-btn {
      height: 3rem; 
      flex-wrap: nowrap; 
      margin-right: 0.25rem; 
    }
    .btn-group.flex-nowrap {
      flex-wrap: nowrap !important;
    }
    .bg-step-0, .bg-step-0 td { background-color: #6c757d !important; color: #fff !important; }
    .bg-step-1, .bg-step-1 td { background-color: #ffc107 !important; color: #212529 !important; }
    .bg-step-2, .bg-step-2 td { background-color: #0d6efd !important; color: #fff !important; }
    .bg-step-3, .bg-step-3 td { background-color: #198754 !important; color: #fff !important; }
    
    @keyframes blink {
      0% { opacity: 1; }
      50% { opacity: 0.3; }
      100% { opacity: 1; }
    }
    .blink-alert {
      animation: blink 1s infinite;
      background-color: #dc3545 !important;
    }
    .blink-alert td { background-color: #dc3545 !important; }
  </style>
</head>
<body class="bg-light">
<div class="container mt-5">
  <h2 class="mb-4">Briefings Agendados</h2>
  <div class="d-flex align-items-center mb-3">
    <div class="form-check form-switch me-3">
      <input class="form-check-input" type="checkbox" id="toggleView">
      <label class="form-check-label" for="toggleView">Tabela</label>
    </div>
    <div class="form-check form-switch" id="toggleCompactContainer" style="display:none">
      <input class="form-check-input" type="checkbox" id="toggleCompact">
      <label class="form-check-label" for="toggleCompact">Compacto</label>
    </div>
  </div>
  <div id="briefingArea"></div>
</div>

<script>
const STEP_LABELS = ["Solicitado","Verificado Auxiliar","Verificado Previsor","Enviado"];
const scheduledBriefings = [
  {
    origem:"SBMO", rota:"SBMO -> SBRF", destino:"SBRF", nivelVoo:"280",
    etd:"2025-04-02T13:50", eta:"2025-04-02T15:20", 
    horaEntrega: new Date(Date.now() + 300000).toISOString(), // 5 minutos
    tipoAeronave:"Asa Fixa",
    observacoes:"⚠️ ALERTA: Previsão de tempestade!",
    maxStep:2
  },
  {
    origem:"SBPS", rota:"SBPS -> SBSV", destino:"SBSV", nivelVoo:"220",
    etd:"2025-03-30T09:00", eta:"2025-03-30T10:10", 
    horaEntrega:"2025-03-29T18:00",
    tipoAeronave:"Asa Fixa",
    observacoes:"Condições de teto e visibilidade na serra.",
    maxStep:0
  },
  {
    origem:"SBKP", rota:"SBKP -> SBBR", destino:"SBBR", nivelVoo:"350",
    etd:"2025-04-01T06:30", eta:"2025-04-01T08:15", 
    horaEntrega:"2025-03-31T22:30",
    tipoAeronave:"Asa Móvel",
    observacoes:"Informar variação de vento cruzado em rota.",
    maxStep:1
  },
  {
    origem:"SBGL", rota:"SBGL -> SBNF", destino:"SBNF", nivelVoo:"320",
    etd:"2025-04-05T07:00", eta:"2025-04-05T08:40", 
    horaEntrega:"2025-04-04T21:00",
    tipoAeronave:"Asa Móvel",
    observacoes:"Possível névoa matinal. Necessito de detalhes de RVR.",
    maxStep:3
  }
];

let tableView = false, compactMode = false;

function sortBriefings() {
  return [...scheduledBriefings].sort((a, b) => {
    return new Date(a.horaEntrega) - new Date(b.horaEntrega);
  });
}

function checkAlertCondition(b) {
  if(b.maxStep >= 3) return false;
  const now = new Date();
  const deadline = new Date(b.horaEntrega);
  return deadline - now <= 600000 && deadline > now;
}

function rowOrCardBgClass(m){
  return `bg-step-${m}`;
}

function getStepLabel(i){ return STEP_LABELS[i] || "?"; }

function toggleStep(idx,i){
  let c = scheduledBriefings[idx].maxStep;
  scheduledBriefings[idx].maxStep = i > c ? i : Math.max(0, i-1);
  renderView();
}

function renderStepButtons(idx, maxS, isTable){
  const g = document.createElement("div");
  g.role = "group";
  g.className = isTable ? "btn-group flex-nowrap" : "btn-group d-flex flex-wrap";
  
  STEP_LABELS.forEach((label, i) => {
    const inp = document.createElement("input");
    inp.type = "checkbox";
    inp.className = "btn-check";
    inp.id = `btn-${idx}-${i}`;
    inp.checked = (i <= maxS);
    inp.onchange = () => toggleStep(idx, i);

    const lbl = document.createElement("label");
    lbl.className = `btn btn-secondary me-1 ${isTable ? "table-step-btn" : ""}`;
    lbl.title = isTable ? label : "";
    lbl.textContent = isTable ? "" : label;
    lbl.htmlFor = inp.id;

    g.append(inp, lbl);
  });
  return g;
}

function renderCards(container){
  const row = document.createElement("div");
  row.className = "row";
  
  sortBriefings().forEach((b, idx) => {
    const col = document.createElement("div");
    col.className = "col-sm-12 col-md-6 col-lg-4 mb-3";

    const card = document.createElement("div");
    card.className = `card h-100 ${rowOrCardBgClass(b.maxStep)} ${checkAlertCondition(b) ? "blink-alert" : ""}`;

    const body = document.createElement("div");
    body.className = "card-body";
    body.innerHTML = `
      <h4 class="card-title fw-bold text-uppercase mb-3">${b.origem} → ${b.destino}</h4>
      ${!compactMode ? `
        <h6 class="card-subtitle mb-2">Rota: ${b.rota}</h6>
        <p>Nível: FL${b.nivelVoo}</p>
        <p>Tipo: ${b.tipoAeronave}</p>
        <p>ETD: ${new Date(b.etd).toLocaleString()}</p>
        <p>ETA: ${new Date(b.eta).toLocaleString()}</p>
        <p>Entrega: ${new Date(b.horaEntrega).toLocaleString()}</p>
      ` : ""}
      <p>Obs: ${b.observacoes}</p>
      <p><strong>Passo:</strong> ${getStepLabel(b.maxStep)}</p>
    `;
    
    body.append(renderStepButtons(idx, b.maxStep, false));
    card.append(body);
    col.append(card);
    row.append(col);
  });
  container.append(row);
}

function renderTable(container){
  const tbl = document.createElement("table");
  tbl.className = "table table-bordered";
  tbl.innerHTML = `
    <thead>
      <tr>
        <th>Origem</th><th>Rota</th><th>Destino</th><th>Nível</th>
        <th>ETD</th><th>ETA</th><th>Entrega</th><th>Aeronave</th>
        <th>Obs</th><th>Passo</th><th>Ações</th>
      </tr>
    </thead>
    <tbody>
      ${sortBriefings().map((b, idx) => `
        <tr class="${rowOrCardBgClass(b.maxStep)} ${checkAlertCondition(b) ? "blink-alert" : ""}">
          <td>${b.origem}</td><td>${b.rota}</td><td>${b.destino}</td>
          <td>FL${b.nivelVoo}</td><td>${new Date(b.etd).toLocaleString()}</td>
          <td>${new Date(b.eta).toLocaleString()}</td>
          <td>${new Date(b.horaEntrega).toLocaleString()}</td>
          <td>${b.tipoAeronave}</td><td>${b.observacoes}</td>
          <td>${getStepLabel(b.maxStep)}</td>
          <td>${renderStepButtons(idx, b.maxStep, true).outerHTML}</td>
        </tr>
      `).join("")}
    </tbody>
  `;
  container.append(tbl);
}

function renderView(){
  const container = document.getElementById("briefingArea");
  container.innerHTML = "";
  document.getElementById("toggleCompactContainer").style.display = tableView ? "none" : "block";
  tableView ? renderTable(container) : renderCards(container);
}

document.getElementById("toggleView").addEventListener("change", e => {
  tableView = e.target.checked;
  renderView();
});

document.getElementById("toggleCompact").addEventListener("change", e => {
  compactMode = e.target.checked;
  renderView();
});

setInterval(renderView, 10000);
renderView();
</script>
</body>
</html>
