<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Gerenciamento de Briefings</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    .form-switch .form-check-input {
      width: 3em; 
      margin-left: -2.5em;
    }
    .btn-check + .btn {
      position: relative; 
      min-width: 2.5rem;
    }
    .btn-check:checked + .btn {
      background-color: #f8f9fa !important;
      border-color: #f8f9fa !important; 
      color: #212529 !important; 
    }
    .btn-check:checked + .btn::before {
      content: "✔";
      color: #000; 
      position: absolute; 
      left: 0.5rem; 
      top: 0.3rem;
    }
    .table-step-btn {
      height: 3rem; 
      flex-wrap: nowrap; 
      margin-right: 0.25rem; 
    }
    .btn-group.flex-nowrap {
      flex-wrap: nowrap !important;
    }
    .bg-step-0, .bg-step-0 td { background-color: #6c757d !important; color: #fff !important; }
    .bg-step-1, .bg-step-1 td { background-color: #ffc107 !important; color: #212529 !important; }
    .bg-step-2, .bg-step-2 td { background-color: #0d6efd !important; color: #fff !important; }
    .bg-step-3, .bg-step-3 td { background-color: #198754 !important; color: #fff !important; }
    
    @keyframes blink {
      0% { opacity: 1; }
      50% { opacity: 0.3; }
      100% { opacity: 1; }
    }
    .blink-alert {
      animation: blink 1s infinite;
      background-color: #dc3545 !important;
    }
    .blink-alert td { background-color: #dc3545 !important; }
  </style>
</head>
<body class="bg-light">
<div class="container mt-5">
  <h2 class="mb-4">Briefings Agendados</h2>
  <div class="d-flex align-items-center mb-3">
    <div class="form-check form-switch me-3">
      <input class="form-check-input" type="checkbox" id="toggleView">
      <label class="form-check-label" for="toggleView">Tabela</label>
    </div>
    <div class="form-check form-switch" id="toggleCompactContainer" style="display:none">
      <input class="form-check-input" type="checkbox" id="toggleCompact">
      <label class="form-check-label" for="toggleCompact">Compacto</label>
    </div>
  </div>
  <div id="briefingArea"></div>
</div>

<script>
const STEP_LABELS = ["Solicitado","Verificado Auxiliar","Verificado Previsor","Enviado"];
const scheduledBriefings = [
  {
    origem:"SBMO", rota:"SBMO -> SBRF", destino:"SBRF", nivelVoo:"280",
    etd:"2025-04-02T13:50", eta:"2025-04-02T15:20", 
    horaEntrega: new Date(Date.now() + 300000).toISOString(),
    tipoAeronave:"Asa Fixa",
    observacoes:"⚠️ ALERTA: Previsão de tempestade!",
    maxStep:2
  },
  {
    origem:"SBPS", rota:"SBPS -> SBSV", destino:"SBSV", nivelVoo:"220",
    etd:"2025-03-30T09:00", eta:"2025-03-30T10:10", 
    horaEntrega:"2025-03-29T18:00",
    tipoAeronave:"Asa Fixa",
    observacoes:"Condições de teto e visibilidade na serra.",
    maxStep:0
  },
  {
    origem:"SBKP", rota:"SBKP -> SBBR", destino:"SBBR", nivelVoo:"350",
    etd:"2025-04-01T06:30", eta:"2025-04-01T08:15", 
    horaEntrega:"2025-03-31T22:30",
    tipoAeronave:"Asa Móvel",
    observacoes:"Informar variação de vento cruzado em rota.",
    maxStep:1
  },
  {
    origem:"SBGL", rota:"SBGL -> SBNF", destino:"SBNF", nivelVoo:"320",
    etd:"2025-04-05T07:00", eta:"2025-04-05T08:40", 
    horaEntrega:"2025-04-04T21:00",
    tipoAeronave:"Asa Móvel",
    observacoes:"Possível névoa matinal. Necessito de detalhes de RVR.",
    maxStep:3
  }
];

let tableView = false, compactMode = false;

function ordenarBriefings() {
  return [...scheduledBriefings].sort((a, b) => {
    return new Date(a.horaEntrega) - new Date(b.horaEntrega);
  });
}

function verificarAlerta(b) {
  if(b.maxStep >= 3) return false;
  const agora = new Date();
  const prazo = new Date(b.horaEntrega);
  return prazo - agora <= 600000 && prazo > agora;
}

function classeDeFundo(passo){
  return `bg-step-${passo}`;
}

function obterEtapa(i){ return STEP_LABELS[i] || "?"; }

function alterarEtapa(idx, i){
  let atual = scheduledBriefings[idx].maxStep;
  scheduledBriefings[idx].maxStep = i > atual ? i : Math.max(0, i-1);
  renderizar();
}

function renderizarBotoes(idx, etapaMax, tabela){
  const grupo = document.createElement("div");
  grupo.role = "group";
  grupo.className = tabela ? "btn-group flex-nowrap" : "btn-group d-flex flex-wrap";
  
  STEP_LABELS.forEach((rotulo, i) => {
    const input = document.createElement("input");
    input.type = "checkbox";
    input.className = "btn-check";
    input.id = `btn-${idx}-${i}`;
    input.checked = (i <= etapaMax);
    input.onchange = () => alterarEtapa(idx, i);

    const label = document.createElement("label");
    label.className = `btn btn-secondary me-1 ${tabela ? "table-step-btn" : ""}`;
    label.title = tabela ? rotulo : "";
    label.textContent = tabela ? "" : rotulo;
    label.htmlFor = input.id;

    grupo.append(input, label);
  });
  return grupo;
}

function renderizarCards(container){
  const linha = document.createElement("div");
  linha.className = "row";
  
  ordenarBriefings().forEach((b, idx) => {
    const coluna = document.createElement("div");
    coluna.className = "col-sm-12 col-md-6 col-lg-4 mb-3";

    const card = document.createElement("div");
    card.className = `card h-100 ${classeDeFundo(b.maxStep)} ${verificarAlerta(b) ? "blink-alert" : ""}`;

    const corpo = document.createElement("div");
    corpo.className = "card-body";
    corpo.innerHTML = `
      <h4 class="card-title fw-bold text-uppercase mb-3">${b.origem} → ${b.destino}</h4>
      ${!compactMode ? `
        <h6 class="card-subtitle mb-2">Rota: ${b.rota}</h6>
        <p>Nível: FL${b.nivelVoo}</p>
        <p>Tipo: ${b.tipoAeronave}</p>
        <p>ETD: ${new Date(b.etd).toLocaleString()}</p>
        <p>ETA: ${new Date(b.eta).toLocaleString()}</p>
      ` : ""}
      <p>Entrega: ${new Date(b.horaEntrega).toLocaleString()}</p>
      <p>Obs: ${b.observacoes}</p>
      <p><strong>Passo:</strong> ${obterEtapa(b.maxStep)}</p>
    `;
    
    if(!compactMode) {
      corpo.append(renderizarBotoes(idx, b.maxStep, false));
    }
    
    card.append(corpo);
    coluna.append(card);
    linha.append(coluna);
  });
  container.append(linha);
}

function renderizarTabela(container){
  const tabela = document.createElement("table");
  tabela.className = "table table-bordered";
  tabela.innerHTML = `
    <thead>
      <tr>
        <th>Origem</th><th>Rota</th><th>Destino</th><th>Nível</th>
        <th>ETD</th><th>ETA</th><th>Entrega</th><th>Aeronave</th>
        <th>Obs</th><th>Passo</th><th>Ações</th>
      </tr>
    </thead>
    <tbody>
      ${ordenarBriefings().map((b, idx) => `
        <tr class="${classeDeFundo(b.maxStep)} ${verificarAlerta(b) ? "blink-alert" : ""}">
          <td>${b.origem}</td><td>${b.rota}</td><td>${b.destino}</td>
          <td>FL${b.nivelVoo}</td><td>${new Date(b.etd).toLocaleString()}</td>
          <td>${new Date(b.eta).toLocaleString()}</td>
          <td>${new Date(b.horaEntrega).toLocaleString()}</td>
          <td>${b.tipoAeronave}</td><td>${b.observacoes}</td>
          <td>${obterEtapa(b.maxStep)}</td>
          <td>${renderizarBotoes(idx, b.maxStep, true).outerHTML}</td>
        </tr>
      `).join("")}
    </tbody>
  `;
  container.append(tabela);
}

function renderizar(){
  const container = document.getElementById("briefingArea");
  container.innerHTML = "";
  document.getElementById("toggleCompactContainer").style.display = tableView ? "none" : "block";
  tableView ? renderizarTabela(container) : renderizarCards(container);
}

document.getElementById("toggleView").addEventListener("change", e => {
  tableView = e.target.checked;
  renderizar();
});

document.getElementById("toggleCompact").addEventListener("change", e => {
  compactMode = e.target.checked;
  renderizar();
});

setInterval(renderizar, 10000);
renderizar();
</script>
</body>
</html>
